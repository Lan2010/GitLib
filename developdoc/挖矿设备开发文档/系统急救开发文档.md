## 系统急救


为了防止设备管控模块rctl异常状态下，平台失去对设备管控的能力，故而开发出系统急救模块，该模块旨在系统启动后定时上报系统必要参数以供系统核查设备异常状态，并且具备执行平台下发脚本的能力，利用平台下发的脚本来进行系统急救与故障排查，最终修复rctl模块




## 消息

### 设备请求服务器端

GET 请求，样例

```
http://dev.sischain.cn/systemaid?devid=a1c8eea63486b8&vmajor=1&vminor=0&vpatch=2318&brlan=c8:ee:a6:34:86:b9&eth0=c8:ee:a6:34:86:b8&eth1=c8:ee:a6:34:86:b9&wlan0=c8:ee:a6:34:86:b6

```

**注：** 插件会将该url的域名(`dev.sischain.cn`)以及path(`systemaid`)部分写死在代码中，平台开发和设备开发人员协商好后不再做改动，也不能重新配置


### 服务器返回消息格式

系统正常，返回
```
{
	"action":"normal"
}
```

系统异常，尚不进行修复
```
{
	"action":"abnormal"
}
```

**设备对于以上两种情况的回复暂时不再发起请求**


需要进行修复
```
{
	"action":"shell",
	"taskid":"cf20180621223523921",  //本次任务id
	"dl_url":"http://dl.dev.sischain.com/shell/taskcmd.sh",    //脚本所在地址，可携带参数，设备会原封不动的访问完整的url,（该脚本就是用来修复系统错误）
	"shell_sign":"3daacd0a5749df23f32bc2e90aaf2b6d",       //签名
	"notify_url":"http://dev.sischain.com/shell" , // 回调通知url,不可携带参数
}
```

**设备收到该消息后将会按照消息格式下载指定的系统修复脚本并执行，然后通过回调url上报任务执行情况**



**sign计算方法**： 

用指纹字符串 `YXJ2aWs=` 和 `shell_md5`(预下载的文件的md5值)拼接成一串字符串后，再对这个字符串进行MD5计算，得出来的结果作为sign值

md5sum( `YXJ2aWs=` + `${shell_md5}` )



### 平台可获取的有用信息以及异常判断

- 设备公网出口ip地址 (由ip地址可间接拿到设备的大概地理位置，网络运营商)

- 设备各个网卡mac （可查看设备网卡mac是否有异动）

- 查看设备最后离线/在线时间（**重要：设备管控插件会上报设备上下线记录，系统急救插件也会上报设备最新一次上线时间，时间差值大于一定的阈值即认为设备管控插件出现异常**）






